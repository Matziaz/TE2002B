-- StateMach_tb.vhd: Testbench para verificar la FSM de desencriptado
library ieee;
use ieee.std_logic_1164.all;

entity StateMach_tb is
end entity StateMach_tb;

architecture test of StateMach_tb is
  signal Clk, Rst                                       : std_logic := '0';
  signal SubBytesEn, ShiftRowsEn, MixColumnsEn          : std_logic;
  signal AddRoundKeyEn, KeyEn, MuxSel                    : std_logic;
  signal SubBytesFin, ShiftRowsFin, MixColumnsFin       : std_logic := '0';
  signal AddRoundKeyFin, KeyFin                         : std_logic := '0';
begin

  -- Instanciación de la FSM
  uut: entity work.StateMach
    port map(
      Clk            => Clk,
      Rst            => Rst,
      SubBytesEn     => SubBytesEn,    SubBytesFin    => SubBytesFin,
      ShiftRowsEn    => ShiftRowsEn,   ShiftRowsFin   => ShiftRowsFin,
      MixColumnsEn   => MixColumnsEn,  MixColumnsFin  => MixColumnsFin,
      AddRoundKeyEn  => AddRoundKeyEn, AddRoundKeyFin => AddRoundKeyFin,
      KeyEn          => KeyEn,         KeyFin         => KeyFin,
      MuxSel         => MuxSel
    );

  -- Generador de reloj (20 ns de período)
  clk_proc: process
  begin
    Clk <= '0'; wait for 10 ns;
    Clk <= '1'; wait for 10 ns;
  end process clk_proc;

  -- Secuencia de estimulación de flags
  stim_proc: process
  begin
    -- Reset inicial
    Rst <= '1'; wait for 25 ns;
    Rst <= '0';

    -- Ronda inicial
    wait until AddRoundKeyEn = '1';
    wait for 20 ns; AddRoundKeyFin <= '1';
    wait for 20 ns; AddRoundKeyFin <= '0';

    -- Rondas 1..9
    for i in 1 to 9 loop
      -- InvSubBytes
      wait until SubBytesEn = '1';
      wait for 20 ns; SubBytesFin <= '1';
      wait for 20 ns; SubBytesFin <= '0';
      -- InvShiftRows
      wait until ShiftRowsEn = '1';
      wait for 20 ns; ShiftRowsFin <= '1';
      wait for 20 ns; ShiftRowsFin <= '0';
      -- AddRoundKey
      wait until AddRoundKeyEn = '1';
      wait for 20 ns; AddRoundKeyFin <= '1';
      wait for 20 ns; AddRoundKeyFin <= '0';
      -- InvMixColumns
      wait until MixColumnsEn = '1';
      wait for 20 ns; MixColumnsFin <= '1';
      wait for 20 ns; MixColumnsFin <= '0';
    end loop;

    -- Ronda final (sin InvMixColumns)
    -- InvSubBytes
    wait until SubBytesEn = '1';
    wait for 20 ns; SubBytesFin <= '1';
    wait for 20 ns; SubBytesFin <= '0';
    -- InvShiftRows
    wait until ShiftRowsEn = '1';
    wait for 20 ns; ShiftRowsFin <= '1';
    wait for 20 ns; ShiftRowsFin <= '0';
    -- AddRoundKey (final)
    wait until AddRoundKeyEn = '1';
    wait for 20 ns; KeyFin <= '1';

    -- Fin de simulación
    wait for 40 ns;
    report "Simulación terminada. MuxSel=" & std_logic'image(MuxSel);
    wait;
  end process stim_proc;

end architecture test;